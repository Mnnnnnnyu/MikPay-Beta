<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MikPay</title>
  <style>
    :root{
      --bg1:#4e6cff; --bg2:#6fc1ff;
      --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --line:#e5e7eb; --primary:#4e6cff;
      --shadow:0 18px 45px rgba(0,0,0,.22);
      --r:18px;
      --toastBg:rgba(15,23,42,.92);
    }
    body.dark{
      --bg1:#0b1220; --bg2:#111827;
      --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
      --line:#1f2937; --primary:#5b7cfa;
      --shadow:0 18px 55px rgba(0,0,0,.45);
      --toastBg:rgba(255,255,255,.12);
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    body{
      margin:0; min-height:100vh;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      display:flex; align-items:center; justify-content:center;
      padding:18px; color:var(--text);
    }
    .app{
      width:min(440px,100%);
      background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.22);
      border-radius:calc(var(--r) + 10px);
      padding:14px;
      backdrop-filter: blur(10px);
    }
    .panel{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    header{
      display:flex; justify-content:space-between; align-items:center;
      padding:14px 14px; border-bottom:1px solid var(--line);
    }
    .brand{display:flex; gap:10px; align-items:center; user-select:none}
    .logo{
      width:34px;height:34px;border-radius:12px;
      background:linear-gradient(135deg,var(--primary),#9ab2ff);
      box-shadow:0 14px 26px rgba(78,108,255,.35);
    }
    .brand b{cursor:pointer; letter-spacing:.2px}
    .pill{
      font-size:12px; color:var(--muted);
      border:1px solid var(--line);
      padding:6px 10px; border-radius:999px;
      white-space:nowrap;
    }
    .iconbtn{
      border:1px solid var(--line);
      background:transparent;
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
    }
    .screen{padding:16px}
    .title{font-size:22px; margin:6px 0 6px; text-align:center}
    .sub{color:var(--muted); font-size:13px; margin:0 0 14px; text-align:center}

    .tabs{display:flex; gap:8px; margin-top:10px}
    .tab{
      flex:1; text-align:center;
      padding:10px 12px; border-radius:14px;
      border:1px solid var(--line);
      color:var(--muted);
      cursor:pointer; user-select:none;
    }
    .tab.active{
      color:var(--text);
      border-color:rgba(78,108,255,.45);
      background:rgba(78,108,255,.10);
    }

    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      outline:none;
      font-size:15px;
      background:transparent;
      color:var(--text);
    }
    input:focus, textarea:focus{
      border-color:rgba(78,108,255,.55);
      box-shadow:0 0 0 3px rgba(78,108,255,.18)
    }

    .btn{
      width:100%;
      border:none;
      border-radius:14px;
      padding:12px 14px;
      background:var(--primary);
      color:#fff;
      font-weight:800;
      cursor:pointer;
      margin-top:10px;
    }
    .btn.secondary{
      background:transparent;
      color:var(--text);
      border:1px solid var(--line);
      font-weight:800;
    }
    .btn.danger{background:#ef4444}
    .hidden{display:none}

    .card{
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      margin-top:12px;
      background:transparent;
    }
    .balance{
      font-size:34px; font-weight:900; letter-spacing:-.5px;
      margin:6px 0 0;
    }
    .muted{color:var(--muted); font-size:13px}

    .row{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
    .row .btn{flex:1; margin-top:0; min-width:120px}

    .list{margin-top:10px}
    .item{
      border-top:1px solid var(--line);
      padding:10px 0;
    }
    .item:first-child{border-top:none;padding-top:0}
    .item b{display:block}

    /* overlays */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:flex; align-items:center; justify-content:center;
      padding:18px;
    }
    .modal{
      width:min(440px,100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modal header{border-bottom:1px solid var(--line)}
    .close{
      cursor:pointer;
      border:1px solid var(--line);
      background:transparent;
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
    }

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:var(--toastBg); color:#fff;
      padding:10px 12px; border-radius:14px;
      font-size:13px; box-shadow:0 16px 40px rgba(0,0,0,.35);
      max-width:min(560px,92%);
      z-index: 9999;
    }
    body.dark .toast{color:var(--text)}
  </style>
</head>

<body>
  <div class="app">
    <div class="panel">
      <header>
        <div class="brand">
          <div class="logo"></div>
          <b id="brandTap">MikPay</b>
          <span class="pill" id="rolePill">Гость</span>
        </div>
        <button class="iconbtn" id="gearBtn" onclick="openSettings()" aria-label="Настройки">⚙️</button>
      </header>

      <!-- AUTH -->
      <div class="screen" id="authScreen">
        <div class="title">Добро пожаловать</div>
        <p class="sub">Данные хранятся в браузере. Комиссия: 0%.</p>

        <div class="tabs">
          <div class="tab active" id="tabLogin">Вход</div>
          <div class="tab" id="tabReg">Регистрация</div>
        </div>

        <div id="loginBox">
          <label>Email</label>
          <input id="loginEmail" type="email" placeholder="example@mail.com" />
          <label>Пароль</label>
          <input id="loginPass" type="password" placeholder="••••••••" />
          <button class="btn" id="loginBtn">Войти</button>
          <button class="btn secondary" id="forgotBtn">Забыли пароль?</button>
        </div>

        <div id="regBox" class="hidden">
          <label>Email</label>
          <input id="regEmail" type="email" placeholder="example@mail.com" />
          <label>Пароль</label>
          <input id="regPass" type="password" placeholder="Придумайте пароль" />
          <button class="btn" id="regBtn">Создать аккаунт</button>
        </div>
      </div>

      <!-- MAIN -->
      <div class="screen hidden" id="mainScreen">
        <div class="card">
          <div class="muted">Баланс (демо)</div>
          <div class="balance" id="bal">0 ₽</div>
          <div class="row">
            <button class="btn" id="payBtn">Оплатить</button>
            <button class="btn secondary" id="topupBtn">Пополнить</button>
            <button class="btn secondary" id="transferBtn">Перевод</button>
          </div>
          <div class="muted" style="margin-top:10px" id="who">—</div>
        </div>

        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
            <b>История</b>
            <span class="muted" id="opsCount">0 операций</span>
          </div>
          <div class="list" id="opsList">
            <div class="muted">Пока пусто</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div class="overlay hidden" id="settingsOv">
    <div class="modal">
      <header>
        <div class="brand">
          <div class="logo"></div>
          <b>Настройки</b>
          <span class="pill" id="settingsEmail">—</span>
        </div>
        <button class="close" onclick="closeSettings()">✕</button>
      </header>
      <div class="screen">
        <div class="card">
          <b>Профиль</b>
          <div class="muted" id="profileInfo" style="margin-top:6px">—</div>
        </div>

        <div class="card">
          <b>Внешний вид</b>
          <button class="btn secondary" id="themeBtn">Сменить тему</button>
          <div class="muted" style="margin-top:8px">Тема сохраняется в браузере.</div>
        </div>

        <div class="card">
          <b>Безопасность</b>
          <button class="btn secondary" id="changePassBtn">Сменить пароль</button>
          <button class="btn secondary" id="forgotFromSettingsBtn">Забыли пароль?</button>
        </div>

        <div class="card">
          <b>Поддержка</b>
          <div class="muted" style="margin-top:6px">Почта: <b>wwwwliii@outlook.com</b></div>
          <button class="btn secondary" id="supportBtn">Написать в поддержку</button>
        </div>

        <button class="btn danger" id="logoutBtn">Выйти</button>
        <div class="muted" style="text-align:center;margin-top:10px">MikPay • комиссия 0% • beta</div>
      </div>
    </div>
  </div>

  <!-- SUPPORT -->
  <div class="overlay hidden" id="supportOv">
    <div class="modal">
      <header>
        <div class="brand">
          <div class="logo"></div>
          <b>Поддержка</b>
          <span class="pill">wwwwliii@outlook.com</span>
        </div>
        <button class="close" onclick="closeSupport()">✕</button>
      </header>
      <div class="screen">
        <label>Сообщение</label>
        <textarea id="supportMsg" rows="5" placeholder="Опишите проблему…"></textarea>
        <button class="btn" id="sendSupportBtn">Отправить</button>
        <div class="muted" style="margin-top:10px">(Без сервера это форма интерфейса.)</div>
      </div>
    </div>
  </div>

  <!-- CHANGE PASS -->
  <div class="overlay hidden" id="chgOv">
    <div class="modal">
      <header>
        <div class="brand">
          <div class="logo"></div>
          <b>Смена пароля</b>
        </div>
        <button class="close" onclick="closeChangePass()">✕</button>
      </header>
      <div class="screen">
        <label>Текущий пароль</label>
        <input id="oldPass" type="password" placeholder="••••••••" />
        <label>Новый пароль</label>
        <input id="newPass" type="password" placeholder="••••••••" />
        <button class="btn" id="savePassBtn">Сохранить</button>
      </div>
    </div>
  </div>

  <!-- FORGOT PASS -->
  <div class="overlay hidden" id="forgotOv">
    <div class="modal">
      <header>
        <div class="brand">
          <div class="logo"></div>
          <b>Забыли пароль?</b>
        </div>
        <button class="close" onclick="closeForgot()">✕</button>
      </header>
      <div class="screen">
        <div class="card">
          <div class="muted">
            Без сервера письма отправить нельзя. Если аккаунт создан в этом браузере — пароль можно сбросить здесь.
          </div>
        </div>
        <label>Email аккаунта</label>
        <input id="forgotEmail" type="email" placeholder="example@mail.com" />
        <label>Новый пароль</label>
        <input id="forgotNew" type="password" placeholder="••••••••" />
        <button class="btn" id="resetPassBtn">Сбросить пароль</button>
      </div>
    </div>
  </div>

  <!-- ANALYTICS (HIDDEN) -->
  <div class="overlay hidden" id="adminOv">
    <div class="modal">
      <header>
        <div class="brand">
          <div class="logo"></div>
          <b>Аналитика MikPay</b>
          <span class="pill">0% комиссия</span>
        </div>
        <button class="close" onclick="closeAdmin()">✕</button>
      </header>
      <div class="screen">
        <div class="card">
          <div class="muted">Всего потрачено через сервис</div>
          <div class="balance" id="totalSpent">0 ₽</div>
          <div class="muted" id="totalOps" style="margin-top:6px">0 операций</div>
        </div>
        <div class="card">
          <b>Метрики</b>
          <div class="list">
            <div class="item">
              <b>Средний платёж</b>
              <div class="muted" id="avgPay">0 ₽</div>
            </div>
            <div class="item">
              <b>Последняя операция</b>
              <div class="muted" id="lastOp">—</div>
            </div>
          </div>
        </div>
        <div class="muted" style="text-align:center;margin-top:10px">
          Открытие: 5 кликов по “MikPay” → пароль
        </div>
      </div>
    </div>
  </div>

  <div class="toast hidden" id="toast"></div>

<script>
(() => {
  "use strict";

  const ANALYTICS_PASS = "world703";
  const SBER_URL = "https://www.sberbank.ru/payments";

  const K_USERS = "mikpay_users";
  const K_SESSION = "mikpay_session";
  const K_THEME = "mikpay_theme";
  const K_ANALYTICS = "mikpay_analytics";

  const el = (id) => document.getElementById(id);

  const toast = (msg) => {
    const t = el("toast");
    t.textContent = msg;
    t.classList.remove("hidden");
    setTimeout(() => t.classList.add("hidden"), 1600);
  };

  const loadUsers = () => {
    try { return JSON.parse(localStorage.getItem(K_USERS) || "{}"); }
    catch { return {}; }
  };
  const saveUsers = (u) => localStorage.setItem(K_USERS, JSON.stringify(u));

  const loadSession = () => {
    try { return JSON.parse(localStorage.getItem(K_SESSION) || "null"); }
    catch { return null; }
  };
  const saveSession = (s) => localStorage.setItem(K_SESSION, JSON.stringify(s));

  const loadAnalytics = () => {
    try { return JSON.parse(localStorage.getItem(K_ANALYTICS) || '{"totalSpent":0,"ops":0,"last":"—"}'); }
    catch { return { totalSpent:0, ops:0, last:"—" }; }
  };
  const saveAnalytics = (a) => localStorage.setItem(K_ANALYTICS, JSON.stringify(a));

  const money = (n) => {
    const v = Math.max(0, Math.floor(n || 0));
    return v.toLocaleString("ru-RU") + " ₽";
  };

  // theme init
  if (localStorage.getItem(K_THEME) === "dark") document.body.classList.add("dark");

  // mode switch
  const setMode = (mode) => {
    const isLogin = mode === "login";
    el("tabLogin").classList.toggle("active", isLogin);
    el("tabReg").classList.toggle("active", !isLogin);
    el("loginBox").classList.toggle("hidden", !isLogin);
    el("regBox").classList.toggle("hidden", isLogin);
  };

  const showAuth = () => {
    el("authScreen").classList.remove("hidden");
    el("mainScreen").classList.add("hidden");
    el("rolePill").textContent = "Гость";
    el("gearBtn").disabled = true;
  };

  const showMain = () => {
    el("authScreen").classList.add("hidden");
    el("mainScreen").classList.remove("hidden");
    el("gearBtn").disabled = false;
    renderMain();
  };

  const current = () => {
    const s = loadSession();
    if (!s || !s.email) return null;
    const users = loadUsers();
    if (!users[s.email]) return null;
    return { email: s.email, u: users[s.email] };
  };

  const renderMain = () => {
    const c = current();
    if (!c) { showAuth(); return; }

    el("rolePill").textContent = "Пользователь";
    el("bal").textContent = money(c.u.balance || 0);
    el("who").textContent = "Вы вошли как: " + c.email;

    const ops = c.u.ops || [];
    el("opsCount").textContent = ops.length + " операций";
    const list = el("opsList");
    if (!ops.length) {
      list.innerHTML = '<div class="muted">Пока пусто</div>';
    } else {
      list.innerHTML = ops.slice(0, 12).map(o => `
        <div class="item">
          <b>${o.title}</b>
          <div class="muted">${o.when}</div>
        </div>
      `).join("");
    }
  };

  const addOp = (title, amountForAnalytics) => {
    const c = current();
    if (!c) return;

    const users = loadUsers();
    users[c.email].ops = users[c.email].ops || [];
    users[c.email].ops.unshift({ title, when: new Date().toLocaleString("ru-RU") });
    saveUsers(users);

    const a = loadAnalytics();
    a.ops += 1;
    a.last = title;
    if (typeof amountForAnalytics === "number" && amountForAnalytics > 0) {
      a.totalSpent += Math.floor(amountForAnalytics);
    }
    saveAnalytics(a);

    renderMain();
  };

  // AUTH events
  el("tabLogin").addEventListener("click", () => setMode("login"));
  el("tabReg").addEventListener("click", () => setMode("reg"));

  el("regBtn").addEventListener("click", () => {
    const email = el("regEmail").value.trim().toLowerCase();
    const pass  = el("regPass").value;

    if (!email || !pass) return toast("Заполни email и пароль");
    const users = loadUsers();
    if (users[email]) return toast("Аккаунт уже существует");

    users[email] = { pass, balance: 0, ops: [] };
    saveUsers(users);

    toast("Аккаунт создан");
    setMode("login");
    el("loginEmail").value = email;
    el("loginPass").value = pass;
  });

  el("loginBtn").addEventListener("click", () => {
    const email = el("loginEmail").value.trim().toLowerCase();
    const pass  = el("loginPass").value;

    const users = loadUsers();
    if (!users[email] || users[email].pass !== pass) return toast("Неверный email или пароль");

    saveSession({ email });
    toast("Вход выполнен");
    showMain();
  });

  // MAIN events
  el("payBtn").addEventListener("click", () => {
    const sumStr = prompt("Сумма оплаты (₽):", "1000");
    if (sumStr === null) return;
    const sum = Math.floor(Number(sumStr));
    if (!Number.isFinite(sum) || sum <= 0) return toast("Неверная сумма");

    addOp("Оплата через Сбер: " + money(sum), sum);
    toast("Перенаправляю на Сбер…");
    window.open(SBER_URL, "_blank", "noopener,noreferrer");
  });

  el("topupBtn").addEventListener("click", () => {
    const c = current(); if (!c) return;
    const sumStr = prompt("Сумма пополнения (₽):", "1000");
    if (sumStr === null) return;
    const sum = Math.floor(Number(sumStr));
    if (!Number.isFinite(sum) || sum <= 0) return toast("Неверная сумма");

    const users = loadUsers();
    users[c.email].balance = (users[c.email].balance || 0) + sum;
    saveUsers(users);

    addOp("Пополнение: +" + money(sum), sum);
    toast("Готово");
  });

  el("transferBtn").addEventListener("click", () => {
    const c = current(); if (!c) return;
    const to = prompt("Кому (email):", "test@mail.com");
    if (to === null) return;
    const sumStr = prompt("Сумма перевода (₽):", "500");
    if (sumStr === null) return;
    const sum = Math.floor(Number(sumStr));
    if (!Number.isFinite(sum) || sum <= 0) return toast("Неверная сумма");

    const users = loadUsers();
    const bal = users[c.email].balance || 0;
    if (sum > bal) return toast("Недостаточно средств");

    users[c.email].balance = bal - sum;

    const toEmail = String(to).trim().toLowerCase();
    if (users[toEmail]) {
      users[toEmail].balance = (users[toEmail].balance || 0) + sum;
      users[toEmail].ops = users[toEmail].ops || [];
      users[toEmail].ops.unshift({ title: "Перевод получен: +" + money(sum), when: new Date().toLocaleString("ru-RU") });
    }
    saveUsers(users);

    addOp("Перевод: -" + money(sum) + " → " + toEmail, sum);
    toast("Перевод создан");
  });

  // SETTINGS functions + events
  window.openSettings = () => {
    const c = current();
    if (!c) return toast("Сначала войдите");
    el("settingsEmail").textContent = c.email;
    el("profileInfo").textContent = "Платёж идёт через внешний сайт (Сбер). Сервис хранит только локальные данные и историю.";
    el("settingsOv").classList.remove("hidden");
  };
  window.closeSettings = () => el("settingsOv").classList.add("hidden");

  el("themeBtn").addEventListener("click", () => {
    document.body.classList.toggle("dark");
    localStorage.setItem(K_THEME, document.body.classList.contains("dark") ? "dark" : "light");
    toast("Тема изменена");
  });

  const openSupport = () => el("supportOv").classList.remove("hidden");
  window.closeSupport = () => el("supportOv").classList.add("hidden");
  el("supportBtn").addEventListener("click", openSupport);

  el("sendSupportBtn").addEventListener("click", () => {
    const msg = el("supportMsg").value.trim();
    if (!msg) return toast("Введите сообщение");
    el("supportMsg").value = "";
    toast("Сообщение подготовлено");
    window.closeSupport();
  });

  const openChangePass = () => el("chgOv").classList.remove("hidden");
  window.closeChangePass = () => {
    el("chgOv").classList.add("hidden");
    el("oldPass").value=""; el("newPass").value="";
  };
  el("changePassBtn").addEventListener("click", openChangePass);

  el("savePassBtn").addEventListener("click", () => {
    const c = current(); if (!c) return toast("Нет сессии");
    const oldP = el("oldPass").value;
    const newP = el("newPass").value;
    if (!oldP || !newP) return toast("Заполните поля");

    const users = loadUsers();
    if (users[c.email].pass !== oldP) return toast("Текущий пароль неверный");
    users[c.email].pass = newP;
    saveUsers(users);
    toast("Пароль обновлён");
    window.closeChangePass();
  });

  const openForgot = () => el("forgotOv").classList.remove("hidden");
  window.closeForgot = () => {
    el("forgotOv").classList.add("hidden");
    el("forgotEmail").value=""; el("forgotNew").value="";
  };
  el("forgotBtn").addEventListener("click", openForgot);
  el("forgotFromSettingsBtn").addEventListener("click", openForgot);

  el("resetPassBtn").addEventListener("click", () => {
    const email = el("forgotEmail").value.trim().toLowerCase();
    const np = el("forgotNew").value;
    if (!email || !np) return toast("Заполните поля");

    const users = loadUsers();
    if (!users[email]) return toast("Аккаунт не найден в этом браузере");

    users[email].pass = np;
    saveUsers(users);

    toast("Пароль сброшен");
    window.closeForgot();
    setMode("login");
    el("loginEmail").value = email;
    el("loginPass").value = np;
  });

  el("logoutBtn").addEventListener("click", () => {
    saveSession(null);
    window.closeSettings();
    toast("Вы вышли");
    showAuth();
  });

  // HIDDEN ANALYTICS
  let taps = 0;
  el("brandTap").addEventListener("click", () => {
    taps++;
    if (taps >= 5) {
      taps = 0;
      const p = prompt("Пароль аналитики:");
      if (p !== ANALYTICS_PASS) return toast("Неверный пароль");
      openAnalytics();
    }
  });

  function openAnalytics(){
    const a = loadAnalytics();
    el("totalSpent").textContent = money(a.totalSpent);
    el("totalOps").textContent = a.ops + " операций";
    el("avgPay").textContent = a.ops ? money(Math.round(a.totalSpent / a.ops)) : money(0);
    el("lastOp").textContent = a.last || "—";
    el("adminOv").classList.remove("hidden");
  }
  window.closeAdmin = () => el("adminOv").classList.add("hidden");

  // INIT
  el("gearBtn").disabled = true;
  setMode("login");

  const s = loadSession();
  const users = loadUsers();
  if (s && s.email && users[s.email]) showMain();
  else showAuth();
})();
</script>
</body>
</html>
